<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å±±å±¤é»é¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .btn-press:active { transform: scale(0.95); }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 20s linear infinite; }
        .animate-marquee:hover { animation-play-state: paused; }
        .body-lock { overflow: hidden; height: 100vh; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-32">

    <!-- â˜…â˜…â˜… ç’°å¢ƒè¨­å®šå€ â˜…â˜…â˜… -->
    <script>
        // 1. æ­£å¼ç’°å¢ƒ (Prod) - é€™æ˜¯ä½ åŸæœ¬çš„æ­£å¼ç¶²å€
        const PROD_API_URL = "https://script.google.com/macros/s/AKfycbyeUwNCmlOw-fDt-g8fKWj9N9ue9XDZPGOY0tyntNvAXm6rp33oyqmTssA4JbJxcxg5/exec";
        
        // 2. æ¸¬è©¦ç’°å¢ƒ (Dev) - â˜…â˜…â˜… è«‹åœ¨é€™è£¡è²¼ä¸Šä½ å‰›å‰›è¤‡è£½çš„æ–°ç¶²å€ â˜…â˜…â˜…
        const DEV_API_URL = "https://script.google.com/macros/s/AKfycby5BAoiagTWPjT6N7bzKyCp8xWygYosJ7daVBNG8-f1JuLBviMbxALanh9WqTihYv76tQ/exec";
        
        // è‡ªå‹•åˆ‡æ›é‚è¼¯
        const isDevEnv = window.location.href.includes('dev') || 
                         window.location.hostname === '127.0.0.1' || 
                         window.location.hostname === 'localhost';

        const API_URL = isDevEnv ? DEV_API_URL : PROD_API_URL;

        if (isDevEnv) {
             document.title = "ã€æ¸¬è©¦ã€‘" + document.title;
             console.log('ğŸ”§ ç›®å‰è™•æ–¼ [æ¸¬è©¦é–‹ç™¼æ¨¡å¼] - é€£ç·šè‡³æ¸¬è©¦è³‡æ–™åº«');
        }

        // é è¨­ç‡Ÿæ¥­æ™‚é–“
        let OPEN_HOUR = 10;  
        let CLOSE_HOUR = 13; 
    </script>

    <!-- é ‚éƒ¨ Header -->
    <header class="bg-white sticky top-0 z-40 shadow-sm transition-all duration-300" id="main-header">
        <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-orange-200 shadow-lg">
                    <i class="fas fa-utensils text-sm"></i>
                </div>
                <h1 class="text-lg font-bold tracking-wide text-gray-800">å±±å±¤é»é¤</h1>
            </div>
            <button onclick="showAnnouncement()" class="relative p-2 text-gray-400 hover:text-orange-500 transition-colors">
                <i class="fas fa-bell"></i>
                <span id="bell-dot" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
        </div>
    </header>

    <!-- åˆ†é¡å°èˆª -->
    <div id="category-nav" class="sticky top-14 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 py-3 hidden transition-all-300">
        <div class="max-w-md mx-auto flex overflow-x-auto no-scrollbar px-4 space-x-3" id="category-list"></div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-md mx-auto px-4 pt-4 min-h-screen">
        
        <div id="page-menu" class="animate-fade-in">
            <!-- è·‘é¦¬ç‡ˆå€å¡Š -->
            <div id="marquee-section" class="bg-orange-50 border border-orange-100 rounded-xl overflow-hidden relative h-10 flex items-center mb-4 hidden shadow-sm">
                <div class="w-full flex items-center px-3">
                    <i class="fas fa-bullhorn text-orange-500 text-sm mr-2 z-10"></i>
                    <div class="flex-1 overflow-hidden relative h-full flex items-center">
                        <div id="marquee-text" class="animate-marquee text-sm text-orange-800 font-medium w-full pl-2">
                            è®€å–ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <div id="loading-skeleton" class="space-y-4 mt-2">
                <div class="h-32 bg-gray-200 rounded-xl skeleton"></div>
                <div class="h-24 bg-gray-200 rounded-xl skeleton"></div>
                <div class="h-24 bg-gray-200 rounded-xl skeleton"></div>
            </div>
            <div id="menu-container" class="space-y-6 hidden pb-20"></div>
        </div>

        <div id="page-search" class="hidden pt-4">
            <div class="bg-white rounded-2xl shadow-sm p-6 text-center border border-gray-100">
                <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 text-2xl"><i class="fas fa-search"></i></div>
                <h2 class="text-xl font-bold mb-2">æŸ¥è©¢æ­·å²è¨‚å–®</h2>
                <p class="text-gray-400 text-sm mb-6">è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥çœ‹è£½ä½œé€²åº¦</p>
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-phone text-gray-300"></i></div>
                    <input type="tel" id="search-phone" class="w-full pl-10 pr-4 py-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-orange-500 focus:bg-white transition-all outline-none font-medium text-lg" placeholder="09xx-xxx-xxx" maxlength="10">
                </div>
                <button onclick="searchOrder()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200 btn-press transition-all">ç«‹å³æŸ¥è©¢</button>
            </div>
            <div id="search-result" class="mt-6 space-y-4"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 pb-safe pt-2 px-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 flex justify-around h-16 items-start max-w-md mx-auto">
        <button onclick="switchTab('menu')" id="tab-menu" class="flex flex-col items-center space-y-1 w-16 text-orange-500 transition-colors duration-300"><i class="fas fa-utensils text-xl mb-0.5"></i><span class="text-[10px] font-medium">é»é¤</span></button>
        <button onclick="switchTab('search')" id="tab-search" class="flex flex-col items-center space-y-1 w-16 text-gray-400 hover:text-gray-600 transition-colors duration-300"><i class="fas fa-receipt text-xl mb-0.5"></i><span class="text-[10px] font-medium">è¨‚å–®</span></button>
    </nav>

    <div id="floating-cart" onclick="toggleCart()" class="fixed bottom-20 left-4 right-4 max-w-[calc(100%-2rem)] md:max-w-[26rem] md:left-1/2 md:-translate-x-1/2 bg-gray-900 text-white rounded-full p-4 shadow-2xl z-30 flex justify-between items-center transform translate-y-[150%] transition-transform duration-500 cursor-pointer btn-press">
        <div class="flex items-center"><div class="bg-orange-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm mr-3" id="float-count">0</div><span class="font-medium text-sm">æŸ¥çœ‹è³¼ç‰©è»Š</span></div>
        <span class="font-bold text-lg" id="float-total">$0</span>
    </div>

    <!-- è³¼ç‰©è»Š Modal (V4.7 ä¿®æ”¹ï¼šå–æ¶ˆå›ºå®šåº•éƒ¨ï¼Œæ”¹ç‚ºæµå‹•å¼) -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] transition-opacity opacity-0" id="cart-backdrop" onclick="toggleCart()"></div>
        
        <!-- max-h-[85vh] ç¨å¾®èª¿å°ä¸€é»é¿å…é ‚åˆ°ä¸Šé¢ -->
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out max-w-md mx-auto max-h-[85vh] flex flex-col" id="cart-panel">
            
            <div class="w-full flex justify-center pt-3 pb-1" onclick="toggleCart()">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>

            <!-- æ¨™é¡Œåˆ— -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center relative flex-shrink-0">
                <button onclick="toggleCart()" class="text-gray-300 hover:text-gray-500 p-2 -ml-2 transition-colors">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-800 absolute left-1/2 transform -translate-x-1/2">æ‚¨çš„é¤é»</h2>
                <button onclick="clearCart()" class="text-xs text-red-500 font-medium px-2 py-1 bg-red-50 rounded-md hover:bg-red-100 transition-colors">æ¸…ç©º</button>
            </div>

            <!-- â˜…â˜…â˜… çµ±ä¸€æ²å‹•å€åŸŸï¼šæ‰€æœ‰å…§å®¹éƒ½åœ¨é€™è£¡é¢ â˜…â˜…â˜… -->
            <div class="flex-1 overflow-y-auto p-6 pb-safe" id="cart-scroll-area">
                
                <!-- 1. ç‡Ÿæ¥­ç‹€æ…‹æç¤º -->
                <div id="shop-closed-banner" class="hidden bg-gray-800 text-white px-4 py-2 text-xs text-center font-bold tracking-wide rounded-lg mb-4">
                    <i class="fas fa-moon mr-1 text-yellow-400"></i> ç›®å‰ä¼‘æ¯ä¸­ï¼Œæ­¤è¨‚å–®ç‚ºé ç´„å–®
                </div>

                <!-- 2. è³¼ç‰©è»Šæ¸…å–® -->
                <div id="cart-items" class="space-y-4 min-h-[50px] mb-6"></div>

                <!-- åˆ†éš”ç·š -->
                <div class="border-t border-gray-100 mb-6"></div>

                <!-- 3. è¼¸å…¥è¡¨å–® -->
                <div class="space-y-4 mb-8">
                    <!-- é ç´„æ™‚é–“ -->
                    <div id="pickup-time-container" class="hidden">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">é è¨ˆå–é¤æ™‚é–“ <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="pickup-time" class="w-full px-4 py-3 rounded-xl border-2 border-orange-200 bg-white shadow-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all font-bold text-gray-700">
                    </div>

                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">ç¨±å‘¼</label>
                        <input type="text" id="customer-name" placeholder="ä¾‹å¦‚ï¼šç‹å…ˆç”Ÿ" class="w-full px-4 py-3 rounded-xl border-none bg-gray-50 shadow-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" id="customer-phone" placeholder="09xxxxxxxx" class="w-full px-4 py-3 rounded-xl border-none bg-gray-50 shadow-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all" maxlength="10">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1 ml-1">å‚™è¨»</label>
                        <input type="text" id="order-note" placeholder="ä¾‹å¦‚ï¼šå¾®è¾£ã€åˆ‡å¡Š" class="w-full px-4 py-3 rounded-xl border-none bg-gray-50 shadow-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all">
                    </div>
                </div>
                
                <!-- 4. ç¸½è¨ˆèˆ‡æŒ‰éˆ• (ç›´æ¥æ”¾åœ¨æ»‘å‹•å€åº•éƒ¨) -->
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-500 font-medium">ç¸½è¨ˆé‡‘é¡</span>
                        <span class="text-3xl font-bold text-gray-900" id="cart-total-modal">$0</span>
                    </div>
                    <button onclick="submitOrder()" id="submit-btn" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg shadow-lg btn-press transition-all flex justify-center items-center">
                        ç¢ºèªé€å‡º
                    </button>
                </div>

                <!-- åº•éƒ¨è¶…å¤§ç•™ç™½ï¼Œé˜²æ­¢è¢«æ‰‹æ©Ÿä¸‹æ–¹æ©«æ¢æ“‹ä½ -->
                <div class="h-24"></div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] w-full max-w-xs space-y-2 pointer-events-none"></div>

    <!-- å…¬å‘Š Modal -->
    <div id="announcement-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAnnouncement()"></div>
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full relative z-10 shadow-2xl transform scale-95 opacity-0 transition-all duration-300" id="announcement-box">
            <div class="w-12 h-12 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mb-4 text-xl">
                <i class="fas fa-bullhorn"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-gray-800">åº—å®¶å…¬å‘Š</h3>
            <p id="announcement-content" class="text-gray-600 leading-relaxed mb-6"></p>
            <button onclick="closeAnnouncement()" class="w-full bg-gray-100 text-gray-800 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        let menuData = [];
        let cart = [];
        let isSubmitting = false;
        let activeCategory = '';
        let isShopOpen = true; 

        window.onload = async function() { await fetchMenu(); };

        function checkBusinessHours(settings) {
            const openSetting = settings.find(s => s.key === 'open_hour');
            const closeSetting = settings.find(s => s.key === 'close_hour');
            if (openSetting) OPEN_HOUR = parseInt(openSetting.value);
            if (closeSetting) CLOSE_HOUR = parseInt(closeSetting.value);
            const now = new Date();
            const hour = now.getHours();
            isShopOpen = (hour >= OPEN_HOUR && hour < CLOSE_HOUR);
            updateShopStatusUI();
        }

        function updateShopStatusUI() {
            const banner = document.getElementById('shop-closed-banner');
            const pickupContainer = document.getElementById('pickup-time-container');
            const submitBtn = document.getElementById('submit-btn');

            if (isShopOpen) {
                banner.classList.add('hidden');
                pickupContainer.classList.add('hidden');
                submitBtn.innerHTML = "ç¢ºèªé€å‡º";
                submitBtn.classList.remove('bg-orange-600');
                submitBtn.classList.add('bg-gray-900');
            } else {
                banner.classList.remove('hidden');
                pickupContainer.classList.remove('hidden');
                submitBtn.innerHTML = "é€å‡ºé ç´„å–®";
                submitBtn.classList.remove('bg-gray-900');
                submitBtn.classList.add('bg-orange-600'); 
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-exclamation-circle text-red-500"></i>';
            toast.className = `bg-white text-gray-800 px-4 py-3 rounded-xl shadow-lg border border-gray-100 flex items-center space-x-3 transform -translate-y-10 opacity-0 transition-all duration-500`;
            toast.innerHTML = `${icon}<span class="font-medium text-sm">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('-translate-y-10', 'opacity-0'); });
            setTimeout(() => { toast.classList.add('-translate-y-10', 'opacity-0'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        function switchTab(tab) {
            const menuPage = document.getElementById('page-menu');
            const searchPage = document.getElementById('page-search');
            const menuTab = document.getElementById('tab-menu');
            const searchTab = document.getElementById('tab-search');
            const catNav = document.getElementById('category-nav');

            if (tab === 'menu') {
                menuPage.classList.remove('hidden');
                searchPage.classList.add('hidden');
                menuTab.classList.add('text-orange-500');
                menuTab.classList.remove('text-gray-400');
                searchTab.classList.remove('text-orange-500');
                searchTab.classList.add('text-gray-400');
                if(menuData.length > 0) catNav.classList.remove('hidden');
            } else {
                menuPage.classList.add('hidden');
                searchPage.classList.remove('hidden');
                menuTab.classList.remove('text-orange-500');
                menuTab.classList.add('text-gray-400');
                searchTab.classList.add('text-orange-500');
                searchTab.classList.remove('text-gray-400');
                catNav.classList.add('hidden');
            }
        }

        async function fetchMenu() {
            try {
                const response = await fetch(`${API_URL}?t=${new Date().getTime()}`);
                const json = await response.json();
                if (json.status === 'success') {
                    menuData = json.data.menu;
                    renderCategoryNav(menuData);
                    renderMenu(menuData);
                    if (json.data.settings) { setupAnnouncement(json.data.settings); checkBusinessHours(json.data.settings); }
                    if (json.data.marquees) setupMarquee(json.data.marquees);
                    document.getElementById('loading-skeleton').classList.add('hidden');
                    document.getElementById('menu-container').classList.remove('hidden');
                    document.getElementById('category-nav').classList.remove('hidden');
                }
            } catch (e) { console.error(e); showToast('ç„¡æ³•é€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error'); }
        }

        function setupMarquee(marquees) {
            const marqueeSection = document.getElementById('marquee-section');
            const marqueeText = document.getElementById('marquee-text');
            if (marquees && Array.isArray(marquees) && marquees.length > 0) {
                const content = marquees.map(m => m.content).join("    &nbsp;&nbsp;|&nbsp;&nbsp;    ");
                marqueeText.innerHTML = content;
                marqueeSection.classList.remove('hidden');
            } else { marqueeSection.classList.add('hidden'); }
        }

        function renderCategoryNav(menu) {
            const categories = [...new Set(menu.map(item => item.category))].filter(c => c);
            const container = document.getElementById('category-list');
            let html = `<button onclick="filterCategory('all')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all bg-gray-900 text-white shadow-md" data-cat="all">å…¨éƒ¨</button>`;
            categories.forEach(cat => {
                html += `<button onclick="filterCategory('${cat}')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 bg-gray-100 whitespace-nowrap hover:bg-gray-200 transition-all" data-cat="${cat}">${cat}</button>`;
            });
            container.innerHTML = html;
        }

        function filterCategory(cat) {
            activeCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if (btn.dataset.cat === cat) {
                    btn.className = "cat-btn px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition-all bg-gray-900 text-white shadow-md transform scale-105";
                } else {
                    btn.className = "cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 bg-gray-100 whitespace-nowrap hover:bg-gray-200 transition-all";
                }
            });
            if (cat === 'all') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                const element = document.getElementById(`cat-${cat}`);
                if (element) {
                    const offset = 160;
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = element.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offsetPosition = elementPosition - offset;
                    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                }
            }
        }

        function setupAnnouncement(settings) {
            const ann = settings.find(s => s.key === 'announcement');
            if (ann && ann.active) {
                document.getElementById('announcement-content').textContent = ann.value;
                document.getElementById('bell-dot').classList.remove('hidden');
            }
        }
        function showAnnouncement() {
            const modal = document.getElementById('announcement-modal');
            const box = document.getElementById('announcement-box');
            modal.classList.remove('hidden');
            setTimeout(() => { box.classList.remove('scale-95', 'opacity-0'); box.classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeAnnouncement() {
            const modal = document.getElementById('announcement-modal');
            const box = document.getElementById('announcement-box');
            box.classList.remove('scale-100', 'opacity-100');
            box.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderMenu(menu) {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            const categories = [...new Set(menu.map(item => item.category))].filter(c => c);
            categories.forEach(cat => {
                const items = menu.filter(item => item.category === cat);
                let categoryHtml = `<div id="cat-${cat}" class="pt-2"><h3 class="text-xl font-bold text-gray-800 mb-4 px-1 flex items-center">${cat}<span class="ml-2 text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">${items.length}</span></h3><div class="grid gap-4">`;
                items.forEach(item => {
                    const isAvail = (item.available === true || item.available === "TRUE");
                    const imageHtml = item.image 
                        ? `<img src="${item.image}" class="w-24 h-24 object-cover rounded-xl" onerror="this.style.display='none'">` 
                        : `<div class="w-24 h-24 bg-gray-50 rounded-xl flex items-center justify-center text-gray-300"><i class="fas fa-utensils text-2xl"></i></div>`;
                    categoryHtml += `<div onclick="${isAvail ? `addToCart('${item.id}')` : ''}" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-50 flex items-center space-x-4 btn-press transition-all ${!isAvail ? 'opacity-60 grayscale pointer-events-none' : 'cursor-pointer'}">${imageHtml}<div class="flex-1 h-24 flex flex-col justify-between py-1"><div><h4 class="font-bold text-gray-800 line-clamp-1">${item.name}</h4><p class="text-xs text-gray-400 mt-1 line-clamp-2">${item.description || 'æš«ç„¡ä»‹ç´¹'}</p></div><div class="flex justify-between items-end"><span class="font-bold text-lg text-gray-900">$${item.price}</span>${isAvail ? `<button class="w-8 h-8 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center hover:bg-orange-500 hover:text-white transition-colors shadow-sm"><i class="fas fa-plus text-xs"></i></button>` : `<span class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded-md">å”®å®Œ</span>`}</div></div></div>`;
                });
                categoryHtml += `</div></div>`;
                container.innerHTML += categoryHtml;
            });
        }

        function addToCart(id) {
            const item = menuData.find(i => i.id == id);
            const exist = cart.find(c => c.id == id);
            if (exist) exist.count++; else cart.push({ ...item, count: 1 });
            if (navigator.vibrate) navigator.vibrate(50);
            updateCartUI();
        }
        function changeQuantity(id, delta) {
            const item = cart.find(c => c.id == id);
            if (item) { item.count += delta; if (item.count <= 0) cart = cart.filter(c => c.id != id); }
            updateCartUI();
        }
        function clearCart() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')) { cart = []; updateCartUI(); toggleCart(); } }

        function updateCartUI() {
            const totalCount = cart.reduce((sum, i) => sum + i.count, 0);
            const floatBar = document.getElementById('floating-cart');
            const cartItemsContainer = document.getElementById('cart-items');
            document.getElementById('float-count').textContent = totalCount;
            let totalAmount = 0;
            let itemsHtml = '';
            if (cart.length === 0) {
                floatBar.classList.add('translate-y-[150%]');
                itemsHtml = `<div class="flex flex-col items-center justify-center py-10 text-gray-300"><i class="fas fa-shopping-cart text-5xl mb-4 opacity-50"></i><p class="text-sm">è³¼ç‰©è»Šé‚„æ˜¯ç©ºçš„</p><p class="text-xs mt-1">å¿«å»é»äº›å¥½åƒçš„å§ï¼</p></div>`;
            } else {
                floatBar.classList.remove('translate-y-[150%]');
                cart.forEach(item => {
                    totalAmount += item.price * item.count;
                    
                    const imgHtml = item.image 
                        ? `<img src="${item.image}" class="w-12 h-12 object-cover rounded-lg mr-3 border border-gray-100" onerror="this.style.display='none'">` 
                        : `<div class="w-12 h-12 bg-gray-100 rounded-lg mr-3 flex items-center justify-center text-gray-300 text-xs border border-gray-200"><i class="fas fa-utensils"></i></div>`;

                    itemsHtml += `
                        <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-50 shadow-sm">
                            <div class="flex items-center flex-1 min-w-0">
                                ${imgHtml}
                                <div class="truncate">
                                    <h5 class="font-bold text-gray-800 truncate">${item.name}</h5>
                                    <p class="text-xs text-gray-400">$${item.price} / ä»½</p>
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-50 rounded-lg p-1 ml-2">
                                <button onclick="changeQuantity('${item.id}', -1)" class="w-7 h-7 bg-white rounded-md shadow-sm text-gray-600 flex items-center justify-center btn-press"><i class="fas fa-minus text-[10px]"></i></button>
                                <span class="w-8 text-center text-sm font-bold text-gray-700">${item.count}</span>
                                <button onclick="changeQuantity('${item.id}', 1)" class="w-7 h-7 bg-gray-900 text-white rounded-md shadow-sm flex items-center justify-center btn-press"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                            <div class="w-16 text-right font-bold text-gray-800 ml-2">$${item.price * item.count}</div>
                        </div>`;
                });
            }
            cartItemsContainer.innerHTML = itemsHtml;
            document.getElementById('float-total').textContent = '$' + totalAmount;
            document.getElementById('cart-total-modal').textContent = '$' + totalAmount;
        }

        function toggleCart() {
            checkBusinessHours(menuData && menuData.settings ? menuData.settings : []); 
            if (cart.length === 0 && document.getElementById('cart-modal').classList.contains('hidden')) return;
            const modal = document.getElementById('cart-modal');
            const backdrop = document.getElementById('cart-backdrop');
            const panel = document.getElementById('cart-panel');
            if (modal.classList.contains('hidden')) {
                document.body.classList.add('body-lock'); 
                modal.classList.remove('hidden');
                requestAnimationFrame(() => { backdrop.classList.remove('opacity-0'); panel.classList.remove('translate-y-full'); });
            } else {
                document.body.classList.remove('body-lock'); 
                backdrop.classList.add('opacity-0'); panel.classList.add('translate-y-full');
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            }
        }

        function submitOrder() {
            if (cart.length === 0) return showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„', 'error');
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            let note = document.getElementById('order-note').value.trim();

            if (!name) return showToast('è«‹å¡«å¯«ç¨±å‘¼', 'error');
            if (!phone) return showToast('è«‹å¡«å¯«è¯çµ¡é›»è©±', 'error');
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) return showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼', 'error');

            if (!isShopOpen) {
                const pickupTime = document.getElementById('pickup-time').value;
                if (!pickupTime) return showToast('ä¼‘æ¯ä¸­ï¼Œè«‹é¸æ“‡é ç´„å–é¤æ™‚é–“', 'error');
                const d = new Date(pickupTime);
                const formattedTime = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                note = `ã€é ç´„: ${formattedTime}ã€‘ ${note}`;
            }

            if (isSubmitting) return;
            isSubmitting = true;
            const btn = document.getElementById('submit-btn'), originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>è™•ç†ä¸­...'; btn.classList.add('opacity-70', 'pointer-events-none');
            const data = { customerName: name, phone: phone, note: note, totalAmount: cart.reduce((s, i) => s + (i.price * i.count), 0), items: cart.map(i => ({ name: i.name, count: i.count, price: i.price })) };
            fetch(API_URL, { method: 'POST', body: JSON.stringify(data), headers: { "Content-Type": "text/plain;charset=utf-8" } })
            .then(res => res.json()).then(json => {
                if (json.status === 'success') {
                    showToast('è¨‚å–®é€å‡ºæˆåŠŸï¼', 'success');
                    toggleCart(); cart = []; updateCartUI(); document.getElementById('order-note').value = '';
                    document.getElementById('search-phone').value = phone; switchTab('search'); searchOrder();
                } else { showToast('å¤±æ•—ï¼š' + json.message, 'error'); }
            }).catch(e => { showToast('å·²é€å‡ºï¼Œè«‹ç•™æ„è€é—†é€šçŸ¥', 'success'); toggleCart(); cart = []; updateCartUI(); })
            .finally(() => { isSubmitting = false; btn.innerHTML = originalText; btn.classList.remove('opacity-70', 'pointer-events-none'); });
        }

        // æŸ¥è©¢è¨‚å–®é‚è¼¯ (ä¿æŒåŸæ¨£)
        function searchOrder() {
            const phone = document.getElementById('search-phone').value.trim();
            if (!phone) return showToast('è«‹è¼¸å…¥é›»è©±', 'error');
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) return showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼', 'error');

            const container = document.getElementById('search-result');
            container.innerHTML = `<div class="space-y-3"><div class="h-24 bg-gray-100 rounded-xl skeleton"></div><div class="h-24 bg-gray-100 rounded-xl skeleton"></div></div>`;
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'search', phone: phone }), headers: { "Content-Type": "text/plain;charset=utf-8" } })
            .then(res => res.json()).then(json => {
                container.innerHTML = '';
                if (json.status === 'success' && json.orders.length > 0) {
                    json.orders.forEach(order => {
                        let statusBadge = '', borderClass = '', cancelBtn = '';
                        const status = order.status;
                        if(status === 'pending') { statusBadge = '<span class="bg-red-100 text-red-700 text-xs font-bold px-2.5 py-0.5 rounded-full flex items-center">è¨‚å–®æˆç«‹</span>'; borderClass = 'border-l-4 border-red-400'; }
                        else if(status === 'confirmed') { statusBadge = '<span class="bg-orange-100 text-orange-700 text-xs font-bold px-2.5 py-0.5 rounded-full flex items-center animate-pulse"><i class="fas fa-fire mr-1"></i>å‚™é¤ä¸­</span>'; borderClass = 'border-l-4 border-orange-400'; }
                        else if(status === 'done') { statusBadge = '<span class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-0.5 rounded-full flex items-center"><i class="fas fa-check mr-1"></i>å‚™é¤å®Œç•¢</span>'; borderClass = 'border-l-4 border-blue-500'; }
                        else if(status === 'finished') { statusBadge = '<span class="bg-green-100 text-green-700 text-xs font-bold px-2.5 py-0.5 rounded-full flex items-center"><i class="fas fa-check-double mr-1"></i>å·²å®Œæˆ</span>'; borderClass = 'border-l-4 border-green-500'; }
                        else if(status === 'cancelled') { statusBadge = '<span class="bg-gray-100 text-gray-600 text-xs font-bold px-2.5 py-0.5 rounded-full">å·²å–æ¶ˆ</span>'; borderClass = 'border-l-4 border-gray-300'; }

                        if (status === 'pending') { cancelBtn = `<button onclick="cancelOrder('${order.orderId}', this)" class="text-xs text-red-400 font-medium underline mt-2 block text-right w-full hover:text-red-600">å–æ¶ˆè¨‚å–®</button>`; }

                        const date = new Date(order.time);
                        const hh = String(date.getHours()).padStart(2, '0');
                        const mm = String(date.getMinutes()).padStart(2, '0');
                        const timeStr = `${date.getMonth()+1}/${date.getDate()} ${hh}:${mm}`;

                        container.innerHTML += `
                            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-50 ${borderClass} mb-3">
                                <div class="flex justify-between items-start mb-3">
                                    <div><span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">${order.orderId.slice(-6)}</span><div class="text-sm font-bold text-gray-800 mt-0.5">${timeStr}</div></div>
                                    ${statusBadge}
                                </div>
                                <div class="py-3 border-t border-dashed border-gray-200"><p class="text-gray-600 text-sm leading-relaxed">${order.items.replace(/, /g, '<br>')}</p></div>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100"><span class="text-xs text-gray-400">ç¸½é‡‘é¡</span><span class="text-lg font-bold text-gray-900">$${order.total}</span></div>
                                ${cancelBtn}
                            </div>`;
                    });
                } else { container.innerHTML = `<div class="flex flex-col items-center justify-center py-10 bg-white rounded-2xl border border-dashed border-gray-200"><i class="fas fa-search text-4xl text-gray-200 mb-3"></i><p class="text-gray-400 font-medium">æ‰¾ä¸åˆ°ç›¸é—œè¨‚å–®</p></div>`; }
            }).catch(e => { container.innerHTML = `<div class="text-center text-red-400 py-4">æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>`; });
        }

        function cancelOrder(orderId, btn) {
            if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ')) return;
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>å–æ¶ˆä¸­...'; btn.classList.add('text-gray-400', 'cursor-not-allowed'); btn.classList.remove('text-red-400', 'hover:text-red-600', 'underline'); }
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'cancel_order', orderId: orderId, role: 'customer' }) }).then(res => res.json()).then(json => {
                if(json.status === 'success') { showToast('è¨‚å–®å·²å–æ¶ˆ'); searchOrder(); } else { showToast(json.message, 'error'); if(btn) { btn.disabled = false; btn.innerHTML = 'å–æ¶ˆè¨‚å–®'; btn.classList.remove('text-gray-400', 'cursor-not-allowed'); btn.classList.add('text-red-400', 'hover:text-red-600', 'underline'); } }
            });
        }
    </script>
</body>
</html>